# This file uses environment variables
# to override any settings add a file called '.env'
# with new environment variable values
# example: "DATABASE_USERNAME=NikZy"
version: "3"
networks:
  traefik:
    external: true
  hilfling-network: # Used for internal networking

volumes:
  db-data:

services:
  postgres:
    container_name: hilflingdb
    build:
      context: .
      dockerfile: postgres/Dockerfile
    restart: always
    networks:
      - hilfling-network
    volumes:
      - "db-data:/var/lib/postgresql/data" # Database volume
        #- "./postgres/sql:/base-sql" # Think this was init sql schema?
    expose:
      - 5432
    ports:
      - "5432:5432"
    environment:
      # Use env variable if exists, fallback to hilfling
      POSTGRES_USER: ${DATABASE_USERNAME:-hilfling}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-password}
      LISTENING_PORT: ${LISTENING_PORT-8080}

    networks:
      - hilfling-network
    labels:
      - traefik.enable=false

  hilfling-backend:
    container_name: hilfling-backend
    image: fotogjengen/hilfling-backend
    depends_on:
      - postgres
    ports:
      - 8484:8080
    expose:
      - 8080
    networks:
      - traefik
      - hilfling-network
    environment:
      DATABASE_USERNAME: $DATABASE_USERNAME
      DATABASE_PASSWORD: $DATABASE_PASSWORD
      DATABASE_URL:  "jdbc:postgresql://postgres:5432/hilflingdb" #"jdbc:postgresql://postgres:5432/hilflingdb?createDatabaseIfNotExist=true"

    labels:
      - traefik.enable=true
      - traefik.http.routers.hilfling-backend.entrypoints=web # <== Defining the entrypoint for http, **ref: line 30
      - traefik.http.routers.hilfling-backend.entrypoints=websecure # <== Defining the entrypoint for http, **ref: line 30
      - traefik.http.routers.hilfling-backend.rule=Host(`fg-backend.nikzy.no`) # <== Your Domain Name goes here for the http rule
      - traefik.http.routers.hilfling-backend.tls.certresolver=lets-encr # Adds SSL to App
      - traefik.docker.network=traefik

  fg-static:
    container_name: hilfling-static
    #image: fotogjengen/hilfling-static # Don't need to push this to a registry
    build:
      context: ./static-files
      dockerfile: Dockerfile
    environment:
      NGINX_HOST: ${NGINX_HOST:-fg-static.nikzy.no}
      NGINX_PORT: ${NGINX_PORT:-80}
    ports:
      - 8181:${NGINX_PORT:-80}
    networks:
      - traefik
    volumes:
      - ./static-files/static:/usr/share/nginx/html
    labels:
      - traefik.enable=true
      - traefik.http.routers.hilfling-rontend.entrypoints=web # <== Defining the entrypoint for http, **ref: line 30
      - traefik.http.routers.hilfling-static.entrypoints=websecure # <== Defining the entrypoint for http, **ref: line 30
      - traefik.http.routers.hilfling-static.rule=Host(`fg-static.nikzy.no`) # <== Your Domain Name goes here for the http rule
      - traefik.http.routers.hilfling-static.tls.certresolver=lets-encr # Adds SSL to App



